name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ] # mainì´ë‚˜ master ì–´ëŠ ìª½ì´ë“  í‘¸ì‹œë˜ë©´ ì‘ë™

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. ìë°”(Java) ì„¤ì¹˜
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. í”ŒëŸ¬í„°(Flutter) ì—”ì§„ ì„¤ì¹˜
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 4. í”„ë¡œì íŠ¸ ìœ„ì¹˜ íƒìƒ‰ ë° ì›¹ ì„¤ì •/ë¹Œë“œ
      - name: Find, Configure and Build Web
        run: |
          # pubspec.yaml íŒŒì¼ì´ ìˆëŠ” ìœ„ì¹˜ë¥¼ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.
          PUB_PATH=$(find . -name "pubspec.yaml" -not -path '*/.*' | head -n 1)
          
          if [ -z "$PUB_PATH" ]; then
            echo "âŒ ì—ëŸ¬: ë¦¬íŒŒì§€í† ë¦¬ì— pubspec.yaml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë”ë¡œ ì´ë™
          PROJECT_ROOT=$(dirname "$PUB_PATH")
          echo "âœ… í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë°œê²¬: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"
          
          # ğŸ’¡ [í•µì‹¬] ë¹ ì ¸ìˆëŠ” web í´ë” ë° ì„¤ì •ì„ ê°•ì œë¡œ ìƒì„±í•©ë‹ˆë‹¤.
          echo "ğŸŒ ì›¹ í”Œë«í¼ ì„¤ì • ìƒì„± ì¤‘..."
          flutter create . --platforms web
          
          # íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
          echo "ğŸ“¦ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          flutter pub get
          
          # ì›¹ ë¹Œë“œ ì‹¤í–‰ (ë¦¬íŒŒì§€í† ë¦¬ ì´ë¦„ emily_pantheon ê¸°ì¤€)
          echo "ğŸ—ï¸ ì›¹ ë¹Œë“œ ì‹œì‘..."
          flutter build web --release --base-href "/emily_pantheon/"
          
          # ë°°í¬ë¥¼ ìœ„í•´ ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ìµœìƒìœ„(Root)ì˜ build/web í´ë”ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.
          if [ "$PROJECT_ROOT" != "." ]; then
            echo "ğŸšš ë¹Œë“œ ê²°ê³¼ë¬¼ ì´ë™ ì¤‘..."
            mkdir -p ../build
            mv build/web ../build/web
          fi

      # 5. gh-pages ë¸Œëœì¹˜ë¡œ ë¹Œë“œ ê²°ê³¼ë¬¼ ë°°í¬
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
