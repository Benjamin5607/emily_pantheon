name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ] # mainì´ë“  masterë“  í‘¸ì‹œë˜ë©´ ë¬´ì¡°ê±´ ì‘ë™!

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ•µï¸â€â™‚ï¸ [CCTV ë‹¨ê³„] ì—¬ê¸°ì„œ íŒŒì¼ì´ ì–´ë”” ìˆëŠ”ì§€ ë¡œê·¸ì— ë¬´ì¡°ê±´ ì°í™ë‹ˆë‹¤.
      - name: Debug - Show me the files
        run: |
          echo "=== 1. í˜„ì¬ ì‘ì—… ìœ„ì¹˜ ==="
          pwd
          echo "=== 2. ìµœìƒìœ„ íŒŒì¼ ëª©ë¡ ==="
          ls -F
          echo "=== 3. ëª¨ë“  í´ë” ìƒ…ìƒ…ì´ ë’¤ì§€ê¸° ==="
          find . -maxdepth 2 -not -path '*/.*'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # ğŸ”¥ [í•µì‹¬] pubspec.yamlì´ ì–´ë”” ìˆë“  ì°¾ì•„ê°€ì„œ ì¼í•˜ëŠ” ë¡œì§
      - name: Build Web
        run: |
          # pubspec.yamlì´ ìˆëŠ” ìœ„ì¹˜ ì°¾ê¸°
          PUB_PATH=$(find . -name "pubspec.yaml" -not -path '*/.*' | head -n 1)
          if [ -z "$PUB_PATH" ]; then
            echo "âŒ ì—ëŸ¬: ë¦¬íŒŒì§€í† ë¦¬ì— pubspec.yaml íŒŒì¼ì´ ì•„ì˜ˆ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # íŒŒì¼ì´ ìˆëŠ” í´ë”ë¡œ ì´ë™
          PROJECT_ROOT=$(dirname "$PUB_PATH")
          echo "âœ… í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë°œê²¬: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"
          
          flutter pub get
          flutter build web --release --base-href "/emily_pantheon/"
          
          # ë°°í¬ë¥¼ ìœ„í•´ ê²°ê³¼ë¬¼ì„ ë£¨íŠ¸ì˜ build í´ë”ë¡œ ì´ë™
          if [ "$PROJECT_ROOT" != "." ]; then
            mkdir -p ../build
            mv build/web ../build/web
          fi

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
